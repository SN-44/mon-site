<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Accueil</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background-color: #f4f4f4;
  }
  header {
    background-color: #007acc;
    color: white;
    padding: 1rem;
    text-align: center;
  }
  nav {
    display: flex;
    flex-wrap: wrap;
    background-color: #005a99;
  }
  nav a {
    flex: 1 1 25%;
    color: white;
    text-align: center;
    padding: 1rem;
    text-decoration: none;
    font-weight: bold;
    border-right: 1px solid #004c82;
  }
  nav a:last-child {
    border-right: none;
  }
  nav a.active {
    background-color: #004c82;
  }
  main {
    padding: 1rem;
    max-width: 900px;
    margin: auto;
  }
  .dossier {
    background: white;
    padding: 1rem;
    margin-bottom: 10px;
    border-radius: 5px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    position: relative;
  }
  .toggle-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 1.3rem;
    cursor: pointer;
  }
  .actions {
    display: none;
    flex-direction: column;
    margin-top: 10px;
    gap: 8px;
    border-top: 1px solid #ddd;
    padding-top: 10px;
  }
  .actions label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }
  .actions button {
    padding: 6px 12px;
    font-size: 0.9rem;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    background-color: #007acc;
    color: white;
    transition: background-color 0.3s ease;
  }
  .actions button:hover {
    background-color: #005a99;
  }
  input[type="text"] {
    width: 100%;
    padding: 10px;
    font-size: 1rem;
    margin-bottom: 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  button#create-btn {
    background-color: #007acc;
    border: none;
    color: white;
    padding: 10px 16px;
    font-size: 1rem;
    border-radius: 4px;
    cursor: pointer;
  }
  button#create-btn:hover {
    background-color: #005a99;
  }
  @media (max-width: 600px) {
    nav a {
      flex: 1 1 100%;
    }
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body>

<header>
  <h1>Accueil</h1>
</header>

<nav>
  <a href="index.html" class="active">Accueil</a>
  <a href="visite-technique.html">Visite technique</a>
  <a href="suivi-chantier.html">Suivi de chantier</a>
  <a href="mise-en-service.html">Mise en service</a>
</nav>

<main>
  <input type="text" id="dossier-name" placeholder="Nom du dossier" />
  <button id="create-btn">Créer le dossier</button>
  <div id="dossiers-container"></div>
</main>

<script>
  const { jsPDF } = window.jspdf;
  let dossiers = [];

  function chargerDossiers() {
    try {
      const data = localStorage.getItem('dossiers');
      dossiers = data ? JSON.parse(data) : [];
      if (!Array.isArray(dossiers)) dossiers = [];
    } catch {
      dossiers = [];
      localStorage.removeItem('dossiers');
    }
  }

  function enregistrer() {
    localStorage.setItem('dossiers', JSON.stringify(dossiers));
  }

  function renderDossiers() {
    const container = document.getElementById('dossiers-container');
    container.innerHTML = '';

    dossiers.forEach((dossier, index) => {
      const div = document.createElement('div');
      div.className = 'dossier';

      div.innerHTML = `
        <h3>${dossier.nom}</h3>
        <button class="toggle-actions" aria-label="Afficher options">&#x25BC;</button>
        <div class="actions" style="display:none;">
          <label><input type="checkbox" data-index="${index}" data-key="visiteTechnique" ${dossier.visiteTechnique ? 'checked' : ''}> Visite technique</label>
          <label><input type="checkbox" data-index="${index}" data-key="suiviChantier" ${dossier.suiviChantier ? 'checked' : ''}> Suivi chantier</label>
          <label><input type="checkbox" data-index="${index}" data-key="miseEnService" ${dossier.miseEnService ? 'checked' : ''}> Mise en service</label>
          <button class="delete-btn" data-index="${index}">Supprimer</button>
          <button class="export-btn" data-index="${index}">Exporter en PDF</button>
        </div>

        <div class="pdf-content" style="display:none; padding: 10px; max-width: 600px; margin-top: 10px;">
          <h2>Dossier : ${dossier.nom}</h2>
          <h3>Visite Technique</h3>
          <p><strong>Date :</strong> ${dossier.visiteTechniqueData?.date || ''}</p>
          <p><strong>Observations :</strong> ${dossier.visiteTechniqueData?.observations || ''}</p>

          <h3>Suivi de Chantier</h3>
          <p><strong>État :</strong> ${dossier.suiviChantierData?.etat || ''}</p>
          <p><strong>Prochaine étape :</strong> ${dossier.suiviChantierData?.prochaineEtape || ''}</p>

          <h3>Mise en Service</h3>
          <p><strong>Date :</strong> ${dossier.miseEnServiceData?.date || ''}</p>
          <p><strong>Commentaire :</strong> ${dossier.miseEnServiceData?.commentaire || ''}</p>
        </div>
      `;

      container.appendChild(div);

      // Toggle actions event
      const toggleBtn = div.querySelector('.toggle-actions');
      const actionsDiv = div.querySelector('.actions');
      toggleBtn.addEventListener('click', () => {
        actionsDiv.style.display = actionsDiv.style.display === 'flex' ? 'none' : 'flex';
      });

      // Checkbox change event
      actionsDiv.querySelectorAll('input[type=checkbox]').forEach(chk => {
        chk.addEventListener('change', (e) => {
          const i = parseInt(e.target.dataset.index);
          const key = e.target.dataset.key;
          dossiers[i][key] = e.target.checked;
          enregistrer();
        });
      });

      // Delete button event
      actionsDiv.querySelector('.delete-btn').addEventListener('click', () => {
        if (confirm(`Supprimer le dossier "${dossier.nom}" ?`)) {
          dossiers.splice(index, 1);
          enregistrer();
          renderDossiers();
        }
      });

      // Export button event
      actionsDiv.querySelector('.export-btn').addEventListener('click', () => {
        exporterPDF(index, div.querySelector('.pdf-content'));
      });
    });
  }

  function ajouterDossier() {
    const nom = document.getElementById('dossier-name').value.trim();
    if (!nom) {
      alert('Le nom du dossier ne peut pas être vide');
      return;
    }
    // Eviter doublon simple
    if (dossiers.some(d => d.nom.toLowerCase() === nom.toLowerCase())) {
      alert('Un dossier avec ce nom existe déjà');
      return;
    }
    dossiers.push({
      nom,
      visiteTechnique: false,
      suiviChantier: false,
      miseEnService: false,
      visiteTechniqueData: {},
      suiviChantierData: {},
      miseEnServiceData: {}
    });
    document.getElementById('dossier-name').value = '';
    enregistrer();
    renderDossiers();
  }

function exportPDF(index) {
  const dossier = dossiers[index];
  const pdf = new jsPDF();

  pdf.setFont("arial", "normal");
  pdf.setFontSize(12);

  let y = 10;
  pdf.text(`Dossier : ${dossier.nom}`, 10, y);
  y += 10;

  if (dossier.checks.visiteTechnique) {
    pdf.setFont(undefined, 'bold');
    pdf.text("Visite Technique", 10, y);
    y += 7;
    pdf.setFont(undefined, 'normal');
    pdf.text(`Date : ${dossier.visiteTechnique.date || ''}`, 10, y);
    y += 7;
    pdf.text(`Observations : ${dossier.visiteTechnique.observations || ''}`, 10, y);
    y += 12;
  }

  if (dossier.checks.suiviChantier) {
    pdf.setFont(undefined, 'bold');
    pdf.text("Suivi de Chantier", 10, y);
    y += 7;
    pdf.setFont(undefined, 'normal');
    pdf.text(`État : ${dossier.suiviChantier.etat || ''}`, 10, y);
    y += 7;
    pdf.text(`Prochaine étape : ${dossier.suiviChantier.prochaineEtape || ''}`, 10, y);
    y += 12;
  }

  if (dossier.checks.miseEnService) {
    pdf.setFont(undefined, 'bold');
    pdf.text("Mise en Service", 10, y);
    y += 7;
    pdf.setFont(undefined, 'normal');
    pdf.text(`Date : ${dossier.miseEnService.date || ''}`, 10, y);
    y += 7;
    pdf.text(`Commentaire : ${dossier.miseEnService.commentaire || ''}`, 10, y);
    y += 12;
  }

  pdf.save(`Dossier_${dossier.nom}.pdf`);
}


  document.getElementById('create-btn').addEventListener('click', ajouterDossier);

  // Au chargement
  chargerDossiers();
  renderDossiers();
</script>

</body>
</html>
