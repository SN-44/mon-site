<script>
  const { jsPDF } = window.jspdf;
  let dossiers = JSON.parse(localStorage.getItem('dossiers')) || [];

  function enregistrer() {
    localStorage.setItem('dossiers', JSON.stringify(dossiers));
    renderDossiers();
  }

  function ajouterDossier() {
    const nom = document.getElementById('dossier-name').value.trim();
    if (!nom) return;

    dossiers.push({
      nom,
      visiteTechnique: { date: '', observations: '' },
      suiviChantier: { etat: '', prochaineEtape: '' },
      miseEnService: { date: '', commentaire: '' },
      checks: {
        visiteTechnique: false,
        suiviChantier: false,
        miseEnService: false
      }
    });

    document.getElementById('dossier-name').value = '';
    enregistrer();
  }

  function supprimerDossier(index) {
    if (confirm("Voulez-vous vraiment supprimer ce dossier ?")) {
      dossiers.splice(index, 1);
      enregistrer();
    }
  }

  async function exportPDF(index) {
    const dossier = dossiers[index];
    const pdf = new jsPDF();

    pdf.setFont("helvetica", "normal");
    pdf.setFontSize(12);

    let y = 10;
    pdf.text(`Dossier : ${dossier.nom}`, 10, y);
    y += 10;

    if (dossier.checks.visiteTechnique) {
      pdf.setFont(undefined, 'bold');
      pdf.text("Visite Technique", 10, y);
      y += 7;
      pdf.setFont(undefined, 'normal');
      pdf.text(`Date : ${dossier.visiteTechnique.date || ''}`, 10, y);
      y += 7;
      pdf.text(`Observations : ${dossier.visiteTechnique.observations || ''}`, 10, y);
      y += 12;
    }

    if (dossier.checks.suiviChantier) {
      pdf.setFont(undefined, 'bold');
      pdf.text("Suivi de Chantier", 10, y);
      y += 7;
      pdf.setFont(undefined, 'normal');
      pdf.text(`État : ${dossier.suiviChantier.etat || ''}`, 10, y);
      y += 7;
      pdf.text(`Prochaine étape : ${dossier.suiviChantier.prochaineEtape || ''}`, 10, y);
      y += 12;
    }

    if (dossier.checks.miseEnService) {
      pdf.setFont(undefined, 'bold');
      pdf.text("Mise en Service", 10, y);
      y += 7;
      pdf.setFont(undefined, 'normal');
      pdf.text(`Date : ${dossier.miseEnService.date || ''}`, 10, y);
      y += 7;
      pdf.text(`Commentaire : ${dossier.miseEnService.commentaire || ''}`, 10, y);
      y += 12;
    }

    pdf.save(`Dossier_${dossier.nom}.pdf`);
  }

  function toggleActions(index) {
    const actionsDiv = document.getElementById(`actions-${index}`);
    actionsDiv.style.display = actionsDiv.style.display === 'none' ? 'flex' : 'none';
  }

  function toggleCheckbox(index, key) {
    dossiers[index].checks[key] = !dossiers[index].checks[key];
    enregistrer();
  }

  function renderDossiers() {
    const container = document.getElementById('dossiers-container');
    container.innerHTML = '';

    dossiers.forEach((dossier, index) => {
      const div = document.createElement('div');
      div.className = 'dossier';

      div.innerHTML = `
        <h3>${dossier.nom}</h3>
        <button class="toggle-actions" onclick="toggleActions(${index})">▼</button>
        <div class="actions" id="actions-${index}" style="display:none; flex-direction: column; margin-top: 10px; gap: 5px;">
          <div class="action-item">
            <label><input type="checkbox" ${dossier.checks.visiteTechnique ? 'checked' : ''} onchange="toggleCheckbox(${index}, 'visiteTechnique')"> Visite technique</label>
            <label><input type="checkbox" ${dossier.checks.suiviChantier ? 'checked' : ''} onchange="toggleCheckbox(${index}, 'suiviChantier')"> Suivi chantier</label>
            <label><input type="checkbox" ${dossier.checks.miseEnService ? 'checked' : ''} onchange="toggleCheckbox(${index}, 'miseEnService')"> Mise en service</label>
          </div>
          <button onclick="supprimerDossier(${index})">Supprimer</button>
          <button onclick="exportPDF(${index})">Exporter en PDF</button>
        </div>
      `;

      container.appendChild(div);
    });
  }

  renderDossiers();
</script>
