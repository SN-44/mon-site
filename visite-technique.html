<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visite Technique</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0; padding: 0;
    }
    header {
      background-color: #007acc;
      padding: 15px;
      color: white;
      text-align: center;
    }
    nav {
      display: flex;
      background-color: #005a99;
    }
    nav a {
      flex: 1;
      padding: 15px;
      color: white;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s;
    }
    nav a:hover, nav a.active {
      background-color: #004c82;
      font-weight: bold;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .folder {
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .folder-header {
      background-color: #f1f1f1;
      padding: 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    .folder-content {
      display: none;
      padding: 15px;
    }
    .section-title {
      font-weight: bold;
      color: black;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      border: 1px solid #ddd;
      padding: 8px 12px;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    .section-content {
      display: none;
      padding: 10px 15px;
      border-left: 2px solid #007acc;
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 50px;
    }
    .checkbox-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .checkbox-group label {
      font-weight: normal;
      cursor: pointer;
      user-select: none;
    }
    .checkbox-group input[type="checkbox"] {
      margin-right: 5px;
      cursor: pointer;
    }
    .folder-header span, .section-title span {
      transition: transform 0.3s ease;
      font-weight: bold;
      font-size: 18px;
    }
    .expanded > span {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
  <header>
    <h1>Visite Technique</h1>
  </header>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="visite-technique.html" class="active">Visite technique</a>
    <a href="suivi-chantier.html">Suivi de chantier</a>
    <a href="mise-en-service.html">Mise en service</a>
  </nav>
  <main id="folders-container"></main>

  <script>
    const container = document.getElementById('folders-container');
    const folders = JSON.parse(localStorage.getItem('folders')) || [];

    function toggleElement(el) {
      if (el.style.display === 'block') {
        el.style.display = 'none';
        el.previousElementSibling.classList.remove('expanded');
      } else {
        el.style.display = 'block';
        el.previousElementSibling.classList.add('expanded');
      }
    }

    function toggleFolderContent(index) {
      const content = document.getElementById('content-' + index);
      toggleElement(content);
    }

    function toggleSectionContent(id) {
      const content = document.getElementById(id);
      toggleElement(content);
    }

    function saveData(folderIndex, fieldPath, value) {
      let obj = folders[folderIndex].visiteTechnique || {};
      const fields = fieldPath.split('.');
      for(let i = 0; i < fields.length - 1; i++) {
        if(!obj[fields[i]]) obj[fields[i]] = {};
        obj = obj[fields[i]];
      }
      obj[fields[fields.length -1]] = value;
      folders[folderIndex].visiteTechnique = folders[folderIndex].visiteTechnique || {};
      Object.assign(folders[folderIndex].visiteTechnique, obj);
      localStorage.setItem('folders', JSON.stringify(folders));
    }

    function createCheckboxGroup(folderIndex, field, options) {
      // options = [{label:'Oui', value:true}, {label:'Non', value:false}]
      const div = document.createElement('div');
      div.className = 'checkbox-group';

      options.forEach(opt => {
        const label = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.name = `${field}-${folderIndex}`; // same name to allow mutual exclusivity manually
        input.checked = folders[folderIndex].visiteTechnique?.[field] === opt.value;
        input.addEventListener('change', () => {
          // Uncheck all others with same name
          const checkboxes = document.querySelectorAll(`input[name="${field}-${folderIndex}"]`);
          checkboxes.forEach(cb => {
            if(cb !== input) cb.checked = false;
          });
          if(input.checked) {
            saveData(folderIndex, field, opt.value);
          } else {
            saveData(folderIndex, field, null);
          }
        });
        label.appendChild(input);
        label.appendChild(document.createTextNode(opt.label));
        div.appendChild(label);
      });

      return div;
    }

    function render() {
      container.innerHTML = '';
      folders.forEach((folder, i) => {
        const div = document.createElement('div');
        div.className = 'folder';

        // Folder header with toggle
        const header = document.createElement('div');
        header.className = 'folder-header';
        header.innerHTML = `<strong>${folder.name}</strong><span>▼</span>`;
        header.onclick = () => toggleFolderContent(i);

        // Folder content container
        const content = document.createElement('div');
        content.className = 'folder-content';
        content.id = 'content-' + i;

        // === TITRE: RACCORDEMENT ===
        const raccordementTitle = document.createElement('div');
        raccordementTitle.className = 'section-title';
        raccordementTitle.innerHTML = `RACCORDEMENT <span>▼</span>`;
        const raccordementContent = document.createElement('div');
        raccordementContent.className = 'section-content';
        raccordementContent.id = `raccordement-content-${i}`;
        raccordementTitle.onclick = () => toggleSectionContent(raccordementContent.id);

        // contenu: liste déroulante "Type de raccordement"
        const raccordementGroup = document.createElement('div');
        raccordementGroup.className = 'form-group';
        const labelRaccordement = document.createElement('label');
        labelRaccordement.textContent = 'Type de raccordement :';
        const selectRaccordement = document.createElement('select');
        const optionsRaccordement = ['Vente total', 'Autoconsommation', 'Vente de surplus'];
        optionsRaccordement.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          selectRaccordement.appendChild(option);
        });
        selectRaccordement.value = folder.visiteTechnique?.raccordementType || '';
        selectRaccordement.onchange = (e) => saveData(i, 'raccordementType', e.target.value);

        raccordementGroup.appendChild(labelRaccordement);
        raccordementGroup.appendChild(selectRaccordement);
        raccordementContent.appendChild(raccordementGroup);

        // === TITRE: PUISSANCES ===
        const puissancesTitle = document.createElement('div');
        puissancesTitle.className = 'section-title';
        puissancesTitle.innerHTML = `PUISSANCES <span>▼</span>`;
        const puissancesContent = document.createElement('div');
        puissancesContent.className = 'section-content';
        puissancesContent.id = `puissances-content-${i}`;
        puissancesTitle.onclick = () => toggleSectionContent(puissancesContent.id);

        // contenu : deux commentaires
        const puissanceRaccordGroup = document.createElement('div');
        puissanceRaccordGroup.className = 'form-group';
        const labelPuissanceRaccord = document.createElement('label');
        labelPuissanceRaccord.textContent = 'Puissance de raccordement :';
        const inputPuissanceRaccord = document.createElement('textarea');
        inputPuissanceRaccord.rows = 2;
        inputPuissanceRaccord.value = folder.visiteTechnique?.puissanceRaccordement || '';
        inputPuissanceRaccord.oninput = (e) => saveData(i, 'puissanceRaccordement', e.target.value);

        puissanceRaccordGroup.appendChild(labelPuissanceRaccord);
        puissanceRaccordGroup.appendChild(inputPuissanceRaccord);

        const puissanceProjetGroup = document.createElement('div');
        puissanceProjetGroup.className = 'form-group';
        const labelPuissanceProjet = document.createElement('label');
        labelPuissanceProjet.textContent = 'Puissance de projet PV :';
        const inputPuissanceProjet = document.createElement('textarea');
        inputPuissanceProjet.rows = 2;
        inputPuissanceProjet.value = folder.visiteTechnique?.puissanceProjetPV || '';
        inputPuissanceProjet.oninput = (e) => saveData(i, 'puissanceProjetPV', e.target.value);

        puissanceProjetGroup.appendChild(labelPuissanceProjet);
        puissanceProjetGroup.appendChild(inputPuissanceProjet);

        puissancesContent.appendChild(puissanceRaccordGroup);
        puissancesContent.appendChild(puissanceProjetGroup);

        // === TITRE: TRAVAUX ENEDIS ===
        const travauxTitle = document.createElement('div');
        travauxTitle.className = 'section-title';
        travauxTitle.innerHTML = `TRAVAUX ENEDIS <span>▼</span>`;
        const travauxContent = document.createElement('div');
        travauxContent.className = 'section-content';
        travauxContent.id = `travaux-content-${i}`;
        travauxTitle.onclick = () => toggleSectionContent(travauxContent.id);

        // contenu : case à cocher oui/non + commentaire pour "PDL posé(s) lors de la VT :"
        const pdlPosesGroup = document.createElement('div');
        pdlPosesGroup.className = 'form-group';
        const labelPdlPoses = document.createElement('label');
        labelPdlPoses.textContent = 'PDL posé(s) lors de la VT :';

        // checkbox oui/non (mutuellement exclusif)
        const pdlPosesCheckboxes = createCheckboxGroup(i, 'pdlPoseVT', [
          {label: 'Oui', value: true},
          {label: 'Non', value: false}
        ]);

        const pdlPosesComment = document.createElement('textarea');
        pdlPosesComment.rows = 2;
        pdlPosesComment.value = folder.visiteTechnique?.pdlPoseVTCommentaire || '';
        pdlPosesComment.placeholder = 'Commentaire...';
        pdlPosesComment.oninput = (e) => saveData(i, 'pdlPoseVTCommentaire', e.target.value);

        pdlPosesGroup.appendChild(labelPdlPoses);
        pdlPosesGroup.appendChild(pdlPosesCheckboxes);
        pdlPosesGroup.appendChild(pdlPosesComment);

        // contenu : liste déroulante "Nombre de PDL :" 0 à 3
        const nbPdlGroup = document.createElement('div');
        nbPdlGroup.className = 'form-group';
        const labelNbPdl = document.createElement('label');
        labelNbPdl.textContent = 'Nombre de PDL :';
        const selectNbPdl = document.createElement('select');
        for(let val = 0; val <= 3; val++) {
          const option = document.createElement('option');
          option.value = val;
          option.textContent = val;
          selectNbPdl.appendChild(option);
        }
        selectNbPdl.value = folder.visiteTechnique?.nombrePDL ?? 0;
        selectNbPdl.onchange = (e) => saveData(i, 'nombrePDL', e.target.value);

        nbPdlGroup.appendChild(labelNbPdl);
        nbPdlGroup.appendChild(selectNbPdl);

        travauxContent.appendChild(pdlPosesGroup);
        travauxContent.appendChild(nbPdlGroup);

        // assemble sections inside folder content
        content.appendChild(raccordementTitle);
        content.appendChild(raccordementContent);

        content.appendChild(puissancesTitle);
        content.appendChild(puissancesContent);

        content.appendChild(travauxTitle);
        content.appendChild(travauxContent);

        // assemble folder
        div.appendChild(header);
        div.appendChild(content);
        container.appendChild(div);
      });
    }

    render();
  </script>
</body>
</html>
