<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visite Technique</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #007acc;
      padding: 15px;
      color: white;
      text-align: center;
    }
    nav {
      display: flex;
      background-color: #005a99;
    }
    nav a {
      flex: 1;
      padding: 15px;
      color: white;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s;
    }
    nav a:hover,
    nav a.active {
      background-color: #004c82;
      font-weight: bold;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .folder {
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 15px;
      background: #fff;
    }
    .folder-header {
      background-color: #f1f1f1;
      padding: 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      font-size: 18px;
      user-select: none;
    }
    .folder-header span {
      transition: transform 0.3s ease;
    }
    .folder-header.expanded span {
      transform: rotate(180deg);
    }
    .folder-content {
      display: none;
      padding: 15px 20px 20px 20px;
    }

    /* Section principale (titre + contenu) */
    .section {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .section-title {
      background-color: #eee;
      padding: 8px 12px;
      font-weight: bold;
      color: black;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
    }
    .section-title span {
      transition: transform 0.3s ease;
    }
    .section-title.expanded span {
      transform: rotate(180deg);
    }
    .section-content {
      display: none;
      padding: 12px 15px 15px 15px;
      background: #fafafa;
      border-top: 1px solid #ddd;
    }

    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: normal;
    }
    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 7px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      resize: vertical;
    }
    textarea {
      min-height: 40px;
    }
    .checkbox-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .checkbox-group label {
      font-weight: normal;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    button.print-btn {
      margin: 10px 20px 20px 20px;
      padding: 10px 15px;
      background-color: #007acc;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      user-select: none;
    }
    button.print-btn:hover {
      background-color: #005fa3;
    }

    /* Styles pour l'impression */
    @media print {
      nav,
      header,
      button.print-btn {
        display: none !important;
      }
      body {
        background: white !important;
      }
      .folder-content,
      .section-content {
        display: block !important;
      }
      .section-title span,
      .folder-header span {
        display: none !important;
      }
      .section-title,
      .folder-header {
        cursor: default !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Visite Technique</h1>
  </header>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="visite-technique.html" class="active">Visite technique</a>
    <a href="suivi-chantier.html">Suivi de chantier</a>
    <a href="mise-en-service.html">Mise en service</a>
  </nav>
  <main id="folders-container"></main>

  <script>
    const container = document.getElementById('folders-container');
    const folders = JSON.parse(localStorage.getItem('folders')) || [];

    // Toggle dossier content
    function toggleFolderContent(index) {
      const content = document.getElementById('content-' + index);
      const header = document.getElementById('header-' + index);
      if (content.style.display === 'block') {
        content.style.display = 'none';
        header.classList.remove('expanded');
      } else {
        content.style.display = 'block';
        header.classList.add('expanded');
      }
    }

    // Toggle section content inside a folder
    function toggleSectionContent(folderIndex, sectionIndex) {
      const secContent = document.getElementById(`section-content-${folderIndex}-${sectionIndex}`);
      const secTitle = document.getElementById(`section-title-${folderIndex}-${sectionIndex}`);
      if (secContent.style.display === 'block') {
        secContent.style.display = 'none';
        secTitle.classList.remove('expanded');
      } else {
        secContent.style.display = 'block';
        secTitle.classList.add('expanded');
      }
    }

    function saveData(folderIndex, field, value) {
      folders[folderIndex].visiteTechnique = folders[folderIndex].visiteTechnique || {};
      folders[folderIndex].visiteTechnique[field] = value;
      localStorage.setItem('folders', JSON.stringify(folders));
    }

    // Fonction d'impression : déplie tout le contenu d'un dossier puis lance impression
    function printFolder(index) {
      const content = document.getElementById('content-' + index);
      const header = document.getElementById('header-' + index);
      if (!content) return;

      // Ouvre le dossier si fermé
      content.style.display = 'block';
      header.classList.add('expanded');

      // Ouvre toutes les sections
      const allSections = content.querySelectorAll('.section-content');
      const allTitles = content.querySelectorAll('.section-title');
      allSections.forEach(sec => (sec.style.display = 'block'));
      allTitles.forEach(title => title.classList.add('expanded'));

      // Lance la fenêtre d'impression
      window.print();

      // (Optionnel) on peut replier après impression, mais pas obligatoire
      /*
      setTimeout(() => {
        allSections.forEach(sec => (sec.style.display = 'none'));
        allTitles.forEach(title => title.classList.remove('expanded'));
        content.style.display = 'none';
        header.classList.remove('expanded');
      }, 1000);
      */
    }

    function render() {
      container.innerHTML = '';
      folders.forEach((folder, i) => {
        // Dossier principal
        const div = document.createElement('div');
        div.className = 'folder';

        // Header dossier
        const header = document.createElement('div');
        header.className = 'folder-header';
        header.id = 'header-' + i;
        header.innerHTML = `<span>${folder.name}</span><span>▼</span>`;
        header.onclick = () => toggleFolderContent(i);

        // Contenu dossier
        const content = document.createElement('div');
        content.className = 'folder-content';
        content.id = 'content-' + i;

        // === Section PLANNING ===
        const planningSection = document.createElement('div');
        planningSection.className = 'section';

        const planningTitle = document.createElement('div');
        planningTitle.className = 'section-title';
        planningTitle.id = `section-title-${i}-0`;
        planningTitle.innerHTML = `<span>PLANNING</span><span>▼</span>`;
        planningTitle.onclick = () => toggleSectionContent(i, 0);

        const planningContent = document.createElement('div');
        planningContent.className = 'section-content';
        planningContent.id = `section-content-${i}-0`;

        // Intervention en (date)
        const interventionGroup = document.createElement('div');
        interventionGroup.className = 'form-group';
        interventionGroup.innerHTML = '<label>Intervention en :</label>';
        const interventionInput = document.createElement('input');
        interventionInput.type = 'date';
        interventionInput.value = folder.visiteTechnique?.intervention || '';
        interventionInput.onchange = e => saveData(i, 'intervention', e.target.value);
        interventionGroup.appendChild(interventionInput);

        // Équipe (commentaire)
        const equipeGroup = document.createElement('div');
        equipeGroup.className = 'form-group';
        equipeGroup.innerHTML = '<label>Équipe :</label>';
        const equipeTextarea = document.createElement('textarea');
        equipeTextarea.rows = 2;
        equipeTextarea.value = folder.visiteTechnique?.equipe || '';
        equipeTextarea.oninput = e => saveData(i, 'equipe', e.target.value);
        equipeGroup.appendChild(equipeTextarea);

        // Contact chef d'équipe (commentaire)
        const contactGroup = document.createElement('div');
        contactGroup.className = 'form-group';
        contactGroup.innerHTML = '<label>Contact chef d\'équipe :</label>';
        const contactTextarea = document.createElement('textarea');
        contactTextarea.rows = 2;
        contactTextarea.value = folder.visiteTechnique?.contact || '';
        contactTextarea.oninput = e => saveData(i, 'contact', e.target.value);
        contactGroup.appendChild(contactTextarea);

        planningContent.appendChild(interventionGroup);
        planningContent.appendChild(equipeGroup);
        planningContent.appendChild(contactGroup);

        planningSection.appendChild(planningTitle);
        planningSection.appendChild(planningContent);

        // === Section RACCORDEMENT ===
        const raccordementSection = document.createElement('div');
        raccordementSection.className = 'section';

        const raccordementTitle = document.createElement('div');
        raccordementTitle.className = 'section-title';
        raccordementTitle.id = `section-title-${i}-1`;
        raccordementTitle.innerHTML = `<span>RACCORDEMENT</span><span>▼</span>`;
        raccordementTitle.onclick = () => toggleSectionContent(i, 1);

        const raccordementContent = document.createElement('div');
        raccordementContent.className = 'section-content';
        raccordementContent.id = `section-content-${i}-1`;

        // Type de raccordement (liste déroulante)
        const typeGroup = document.createElement('div');
        typeGroup.className = 'form-group';
        typeGroup.innerHTML = '<label>Type de raccordement :</label>';
        const selectType = document.createElement('select');
        const options = ['Vente total', 'Autoconsommation', 'Vente de surplus'];
        options.forEach(opt => {
          const optionEl = document.createElement('option');
          optionEl.value = opt;
          optionEl.textContent = opt;
          selectType.appendChild(optionEl);
        });
        selectType.value = folder.visiteTechnique?.typeRaccordement || '';
        selectType.onchange = e => saveData(i, 'typeRaccordement', e.target.value);
        typeGroup.appendChild(selectType);

        raccordementContent.appendChild(typeGroup);

        raccordementSection.appendChild(raccordementTitle);
        raccordementSection.appendChild(raccordementContent);

        // === Section PUISSANCES ===
        const puissancesSection = document.createElement('div');
        puissancesSection.className = 'section';

        const puissancesTitle = document.createElement('div');
        puissancesTitle.className = 'section-title';
        puissancesTitle.id = `section-title-${i}-2`;
        puissancesTitle.innerHTML = `<span>PUISSANCES</span><span>▼</span>`;
        puissancesTitle.onclick = () => toggleSectionContent(i, 2);

        const puissancesContent = document.createElement('div');
        puissancesContent.className = 'section-content';
        puissancesContent.id = `section-content-${i}-2`;

        // Puissance de raccordement (commentaire)
        const puissanceRaccGroup = document.createElement('div');
        puissanceRaccGroup.className = 'form-group';
        puissanceRaccGroup.innerHTML = '<label>Puissance de raccordement :</label>';
        const puissanceRaccInput = document.createElement('textarea');
        puissanceRaccInput.rows = 1;
        puissanceRaccInput.value = folder.visiteTechnique?.puissanceRaccordement || '';
        puissanceRaccInput.oninput = e => saveData(i, 'puissanceRaccordement', e.target.value);
        puissanceRaccGroup.appendChild(puissanceRaccInput);

        // Puissance de projet PV (commentaire)
        const puissanceProjGroup = document.createElement('div');
        puissanceProjGroup.className = 'form-group';
        puissanceProjGroup.innerHTML = '<label>Puissance de projet PV :</label>';
        const puissanceProjInput = document.createElement('textarea');
        puissanceProjInput.rows = 1;
        puissanceProjInput.value = folder.visiteTechnique?.puissanceProjetPV || '';
        puissanceProjInput.oninput = e => saveData(i, 'puissanceProjetPV', e.target.value);
        puissanceProjGroup.appendChild(puissanceProjInput);

        puissancesContent.appendChild(puissanceRaccGroup);
        puissancesContent.appendChild(puissanceProjGroup);

        puissancesSection.appendChild(puissancesTitle);
        puissancesSection.appendChild(puissancesContent);

        // === Section TRAVAUX ENEDIS ===
        const travauxSection = document.createElement('div');
        travauxSection.className = 'section';

        const travauxTitle = document.createElement('div');
        travauxTitle.className = 'section-title';
        travauxTitle.id = `section-title-${i}-3`;
        travauxTitle.innerHTML = `<span>TRAVAUX ENEDIS</span><span>▼</span>`;
        travauxTitle.onclick = () => toggleSectionContent(i, 3);

        const travauxContent = document.createElement('div');
        travauxContent.className = 'section-content';
        travauxContent.id = `section-content-${i}-3`;

        // PDL posé(s) lors de la VT (oui/non + commentaire)
        const pdlPoseGroup = document.createElement('div');
        pdlPoseGroup.className = 'form-group';
        pdlPoseGroup.innerHTML = '<label>PDL posé(s) lors de la VT :</label>';

        const checkboxYes = document.createElement('input');
        checkboxYes.type = 'checkbox';
        checkboxYes.id = `pdl-oui-${i}`;
        checkboxYes.checked = folder.visiteTechnique?.pdlPose === 'oui';
        checkboxYes.onchange = e => {
          if (e.target.checked) {
            saveData(i, 'pdlPose', 'oui');
            document.getElementById(`pdl-non-${i}`).checked = false;
          } else if (!document.getElementById(`pdl-non-${i}`).checked) {
            saveData(i, 'pdlPose', '');
          }
        };
        const labelYes = document.createElement('label');
        labelYes.htmlFor = `pdl-oui-${i}`;
        labelYes.textContent = 'oui';

        const checkboxNo = document.createElement('input');
        checkboxNo.type = 'checkbox';
        checkboxNo.id = `pdl-non-${i}`;
        checkboxNo.checked = folder.visiteTechnique?.pdlPose === 'non';
        checkboxNo.onchange = e => {
          if (e.target.checked) {
            saveData(i, 'pdlPose', 'non');
            document.getElementById(`pdl-oui-${i}`).checked = false;
          } else if (!document.getElementById(`pdl-oui-${i}`).checked) {
            saveData(i, 'pdlPose', '');
          }
        };
        const labelNo = document.createElement('label');
        labelNo.htmlFor = `pdl-non-${i}`;
        labelNo.textContent = 'non';

        const checkboxContainer = document.createElement('div');
        checkboxContainer.className = 'checkbox-group';
        checkboxContainer.appendChild(checkboxYes);
        checkboxContainer.appendChild(labelYes);
        checkboxContainer.appendChild(checkboxNo);
        checkboxContainer.appendChild(labelNo);

        pdlPoseGroup.appendChild(checkboxContainer);

        // Commentaire pour PDL posé(s)
        const pdlCommentGroup = document.createElement('div');
        pdlCommentGroup.className = 'form-group';
        pdlCommentGroup.innerHTML = '<label>Commentaire :</label>';
        const pdlCommentInput = document.createElement('textarea');
        pdlCommentInput.rows = 2;
        pdlCommentInput.value = folder.visiteTechnique?.pdlCommentaire || '';
        pdlCommentInput.oninput = e => saveData(i, 'pdlCommentaire', e.target.value);
        pdlCommentGroup.appendChild(pdlCommentInput);

        // Nombre de PDL (0 à 3)
        const pdlNbGroup = document.createElement('div');
        pdlNbGroup.className = 'form-group';
        pdlNbGroup.innerHTML = '<label>Nombre de PDL :</label>';
        const selectNb = document.createElement('select');
        ['0', '1', '2', '3'].forEach(val => {
          const option = document.createElement('option');
          option.value = val;
          option.textContent = val;
          selectNb.appendChild(option);
        });
        selectNb.value = folder.visiteTechnique?.pdlNombre || '0';
        selectNb.onchange = e => saveData(i, 'pdlNombre', e.target.value);
        pdlNbGroup.appendChild(selectNb);

        travauxContent.appendChild(pdlPoseGroup);
        travauxContent.appendChild(pdlCommentGroup);
        travauxContent.appendChild(pdlNbGroup);

        travauxSection.appendChild(travauxTitle);
        travauxSection.appendChild(travauxContent);

        // Ajout des sections dans content
        content.appendChild(planningSection);
        content.appendChild(raccordementSection);
        content.appendChild(puissancesSection);
        content.appendChild(travauxSection);

        // Bouton imprimer dossier
        const printBtn = document.createElement('button');
        printBtn.className = 'print-btn';
        printBtn.textContent = 'Imprimer ce dossier';
        printBtn.onclick = () => printFolder(i);
        content.appendChild(printBtn);

        div.appendChild(header);
        div.appendChild(content);

        container.appendChild(div);
      });
    }

    render();
  </script>
</body>
</html>
