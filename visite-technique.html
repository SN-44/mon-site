<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visite Technique</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #007acc;
      padding: 15px;
      color: white;
      text-align: center;
    }
    nav {
      display: flex;
      background-color: #005a99;
    }
    nav a {
      flex: 1;
      padding: 15px;
      color: white;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s;
    }
    nav a:hover,
    nav a.active {
      background-color: #004c82;
      font-weight: bold;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .folder {
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .folder-header {
      background-color: #f1f1f1;
      padding: 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    .folder-header span.arrow {
      display: inline-block;
      transition: transform 0.3s ease;
    }
    .folder-header.open span.arrow {
      transform: rotate(180deg);
    }
    .folder-content {
      display: none;
      padding: 15px;
    }
    .section-title {
      font-weight: bold;
      color: black;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 16px;
      background-color: #e0e0e0;
      padding: 5px 10px;
      border-radius: 4px;
      user-select: none;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-title span.arrow {
      display: inline-block;
      transition: transform 0.3s ease;
    }
    .section-title.open span.arrow {
      transform: rotate(180deg);
    }
    .section-content {
      padding-left: 15px;
      display: none;
    }
    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    select, input[type="text"], input[type="date"], textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      resize: vertical;
    }
    textarea {
      min-height: 40px;
    }
    .checkbox-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .checkbox-group label {
      font-weight: normal;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    button {
      padding: 10px 15px;
      background-color: #007acc;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #005fa3;
    }

    /* Pour impression */
    @media print {
      body {
        background-color: white;
      }
      main {
        box-shadow: none;
        margin: 0;
        padding: 0;
        max-width: 100%;
      }
      .folder-header,
      button,
      nav,
      header {
        display: none !important;
      }
      .folder-content,
      .section-content {
        display: block !important;
      }
      .section-title {
        background-color: transparent !important;
        -webkit-print-color-adjust: exact;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Visite Technique</h1>
  </header>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="visite-technique.html" class="active">Visite technique</a>
    <a href="suivi-chantier.html">Suivi de chantier</a>
    <a href="mise-en-service.html">Mise en service</a>
  </nav>
  <main id="folders-container"></main>

  <script>
    const container = document.getElementById('folders-container');
    const folders = JSON.parse(localStorage.getItem('folders')) || [];

    function toggleContent(index) {
      const content = document.getElementById('content-' + index);
      const header = document.getElementById('header-' + index);
      if (content.style.display === 'block') {
        content.style.display = 'none';
        header.classList.remove('open');
      } else {
        content.style.display = 'block';
        header.classList.add('open');
      }
    }

    function toggleSection(index, sectionId) {
      const content = document.getElementById(`section-content-${index}-${sectionId}`);
      const title = document.getElementById(`section-title-${index}-${sectionId}`);
      if (content.style.display === 'block') {
        content.style.display = 'none';
        title.classList.remove('open');
      } else {
        content.style.display = 'block';
        title.classList.add('open');
      }
    }

    function saveData(folderIndex, section, field, value) {
      folders[folderIndex].visiteTechnique = folders[folderIndex].visiteTechnique || {};
      folders[folderIndex].visiteTechnique[section] = folders[folderIndex].visiteTechnique[section] || {};
      folders[folderIndex].visiteTechnique[section][field] = value;
      localStorage.setItem('folders', JSON.stringify(folders));
    }

    function saveSimpleData(folderIndex, field, value) {
      folders[folderIndex].visiteTechnique = folders[folderIndex].visiteTechnique || {};
      folders[folderIndex].visiteTechnique[field] = value;
      localStorage.setItem('folders', JSON.stringify(folders));
    }

    function printFolder(index) {
      const folder = folders[index];
      if (!folder) return;

      const vt = folder.visiteTechnique || {};
      let html = `<h1>${folder.name}</h1>`;

      function sectionToHtml(title, contentHtml) {
        return `<h2 style="background-color:#e0e0e0; padding:5px;">${title}</h2>${contentHtml}`;
      }

      // PLANNING
      const planning = vt['PLANNING'] || {};
      let planningHtml = `
        <p><strong>Intervention en :</strong> ${planning.intervention || ''}</p>
        <p><strong>Équipe :</strong> ${planning.equipe || ''}</p>
        <p><strong>Contact chef d'équipe :</strong> ${planning.contact || ''}</p>
      `;
      html += sectionToHtml('PLANNING', planningHtml);

      // RACCORDEMENT
      const raccordement = vt['RACCORDEMENT'] || {};
      let raccordementHtml = `<p><strong>Type de raccordement :</strong> ${raccordement.type || ''}</p>`;
      html += sectionToHtml('RACCORDEMENT', raccordementHtml);

      // PUISSANCES
      const puissances = vt['PUISSANCES'] || {};
      let puissancesHtml = `
        <p><strong>Puissance de raccordement :</strong> ${puissances.puissanceRaccordement || ''}</p>
        <p><strong>Puissance de projet PV :</strong> ${puissances.puissanceProjet || ''}</p>
      `;
      html += sectionToHtml('PUISSANCES', puissancesHtml);

      // TRAVAUX ENEDIS
      const travaux = vt['TRAVAUX ENEDIS'] || {};
      let travauxHtml = `
        <p><strong>PDL posé(s) lors de la VT :</strong> ${travaux.pdlPose || ''}</p>
        <p><strong>Commentaire :</strong> ${travaux.commentaire || ''}</p>
        <p><strong>Nombre de PDL :</strong> ${travaux.nombrePdl || ''}</p>
      `;
      html += sectionToHtml('TRAVAUX ENEDIS', travauxHtml);

      // CATEGORIE DU BATIMENT
      const categorie = vt['CATEGORIE DU BATIMENT'] || {};
      let categorieHtml = `
        <p><strong>Type de bâtiment :</strong> ${categorie.typeBatiment || ''}</p>
        <p><strong>Classé :</strong> ${categorie.classe || ''}</p>
      `;
      html += sectionToHtml('CATEGORIE DU BATIMENT', categorieHtml);

      const printWindow = window.open('', '', 'width=800,height=600');
      printWindow.document.write(`
        <html>
          <head>
            <title>Impression dossier - ${folder.name}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1 { text-align: center; }
              h2 {
                background-color: #e0e0e0;
                padding: 5px 10px;
                border-radius: 4px;
                margin-top: 30px;
              }
              p {
                margin: 8px 0;
              }
              strong {
                font-weight: bold;
              }
            </style>
          </head>
          <body>
            ${html}
            <script>
              window.onload = function() {
                window.print();
                window.onafterprint = function() { window.close(); };
              };
            </script>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    function render() {
      container.innerHTML = '';
      folders.forEach((folder, index) => {
        // Folder container
        const div = document.createElement('div');
        div.className = 'folder';

        // Folder header with toggle arrow
        const header = document.createElement('div');
        header.className = 'folder-header';
        header.id = 'header-' + index;
        header.innerHTML = `<strong>${folder.name}</strong><span class="arrow">▼</span>`;
        header.onclick = () => toggleContent(index);

        // Folder content container
        const content = document.createElement('div');
        content.className = 'folder-content';
        content.id = 'content-' + index;

        // PLANNING section
        const planningTitle = document.createElement('div');
        planningTitle.className = 'section-title';
        planningTitle.id = `section-title-${index}-planning`;
        planningTitle.innerHTML = 'PLANNING <span class="arrow">▼</span>';
        planningTitle.onclick = () => toggleSection(index, 'planning');

        const planningContent = document.createElement('div');
        planningContent.className = 'section-content';
        planningContent.id = `section-content-${index}-planning`;

        // Planning fields
        const interventionGroup = document.createElement('div');
        interventionGroup.className = 'form-group';
        interventionGroup.innerHTML = '<label>Intervention en :</label>';
        const interventionInput = document.createElement('input');
        interventionInput.type = 'date';
        interventionInput.value = folder.visiteTechnique?.PLANNING?.intervention || '';
        interventionInput.onchange = (e) =>
          saveData(index, 'PLANNING', 'intervention', e.target.value);
        interventionGroup.appendChild(interventionInput);

        const equipeGroup = document.createElement('div');
        equipeGroup.className = 'form-group';
        equipeGroup.innerHTML = '<label>Équipe :</label>';
        const equipeTextarea = document.createElement('textarea');
        equipeTextarea.rows = 2;
        equipeTextarea.value = folder.visiteTechnique?.PLANNING?.equipe || '';
        equipeTextarea.oninput = (e) =>
          saveData(index, 'PLANNING', 'equipe', e.target.value);
        equipeGroup.appendChild(equipeTextarea);

        const contactGroup = document.createElement('div');
        contactGroup.className = 'form-group';
        contactGroup.innerHTML = "<label>Contact chef d'équipe :</label>";
        const contactTextarea = document.createElement('textarea');
        contactTextarea.rows = 2;
        contactTextarea.value = folder.visiteTechnique?.PLANNING?.contact || '';
        contactTextarea.oninput = (e) =>
          saveData(index, 'PLANNING', 'contact', e.target.value);
        contactGroup.appendChild(contactTextarea);

        planningContent.appendChild(interventionGroup);
        planningContent.appendChild(equipeGroup);
        planningContent.appendChild(contactGroup);

        // RACCORDEMENT section
        const raccordementTitle = document.createElement('div');
        raccordementTitle.className = 'section-title';
        raccordementTitle.id = `section-title-${index}-raccordement`;
        raccordementTitle.innerHTML = 'RACCORDEMENT <span class="arrow">▼</span>';
        raccordementTitle.onclick = () => toggleSection(index, 'raccordement');

        const raccordementContent = document.createElement('div');
        raccordementContent.className = 'section-content';
        raccordementContent.id = `section-content-${index}-raccordement`;

        const typeRaccordementGroup = document.createElement('div');
        typeRaccordementGroup.className = 'form-group';
        typeRaccordementGroup.innerHTML = '<label>Type de raccordement :</label>';
        const selectRaccordement = document.createElement('select');
        ['','Vente total', 'Autoconsommation', 'Vente de surplus'].forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          if (folder.visiteTechnique?.RACCORDEMENT?.type === opt) option.selected = true;
          selectRaccordement.appendChild(option);
        });
        selectRaccordement.onchange = (e) =>
          saveData(index, 'RACCORDEMENT', 'type', e.target.value);
        typeRaccordementGroup.appendChild(selectRaccordement);
        raccordementContent.appendChild(typeRaccordementGroup);

        // PUISSANCES section
        const puissancesTitle = document.createElement('div');
        puissancesTitle.className = 'section-title';
        puissancesTitle.id = `section-title-${index}-puissances`;
        puissancesTitle.innerHTML = 'PUISSANCES <span class="arrow">▼</span>';
        puissancesTitle.onclick = () => toggleSection(index, 'puissances');

        const puissancesContent = document.createElement('div');
        puissancesContent.className = 'section-content';
        puissancesContent.id = `section-content-${index}-puissances`;

        const puissanceRaccordGroup = document.createElement('div');
        puissanceRaccordGroup.className = 'form-group';
        puissanceRaccordGroup.innerHTML = '<label>Puissance de raccordement :</label>';
        const puissanceRaccordInput = document.createElement('textarea');
        puissanceRaccordInput.rows = 2;
        puissanceRaccordInput.value = folder.visiteTechnique?.PUISSANCES?.puissanceRaccordement || '';
        puissanceRaccordInput.oninput = (e) =>
          saveData(index, 'PUISSANCES', 'puissanceRaccordement', e.target.value);
        puissanceRaccordGroup.appendChild(puissanceRaccordInput);

        const puissanceProjetGroup = document.createElement('div');
        puissanceProjetGroup.className = 'form-group';
        puissanceProjetGroup.innerHTML = '<label>Puissance de projet PV :</label>';
        const puissanceProjetInput = document.createElement('textarea');
        puissanceProjetInput.rows = 2;
        puissanceProjetInput.value = folder.visiteTechnique?.PUISSANCES?.puissanceProjet || '';
        puissanceProjetInput.oninput = (e) =>
          saveData(index, 'PUISSANCES', 'puissanceProjet', e.target.value);
        puissanceProjetGroup.appendChild(puissanceProjetInput);

        puissancesContent.appendChild(puissanceRaccordGroup);
        puissancesContent.appendChild(puissanceProjetGroup);

        // TRAVAUX ENEDIS section
        const travauxTitle = document.createElement('div');
        travauxTitle.className = 'section-title';
        travauxTitle.id = `section-title-${index}-travaux`;
        travauxTitle.innerHTML = 'TRAVAUX ENEDIS <span class="arrow">▼</span>';
        travauxTitle.onclick = () => toggleSection(index, 'travaux');

        const travauxContent = document.createElement('div');
        travauxContent.className = 'section-content';
        travauxContent.id = `section-content-${index}-travaux`;

        const pdlPoseGroup = document.createElement('div');
        pdlPoseGroup.className = 'form-group';
        pdlPoseGroup.innerHTML = '<label>PDL posé(s) lors de la VT :</label>';
        const checkboxOui = document.createElement('input');
        checkboxOui.type = 'radio';
        checkboxOui.name = `pdlPose-${index}`;
        checkboxOui.value = 'oui';
        checkboxOui.checked = folder.visiteTechnique?.['TRAVAUX ENEDIS']?.pdlPose === 'oui';
        checkboxOui.onchange = (e) => {
          if (e.target.checked) saveData(index, 'TRAVAUX ENEDIS', 'pdlPose', e.target.value);
        };
        const labelOui = document.createElement('label');
        labelOui.appendChild(checkboxOui);
        labelOui.appendChild(document.createTextNode('oui'));

        const checkboxNon = document.createElement('input');
        checkboxNon.type = 'radio';
        checkboxNon.name = `pdlPose-${index}`;
        checkboxNon.value = 'non';
        checkboxNon.checked = folder.visiteTechnique?.['TRAVAUX ENEDIS']?.pdlPose === 'non';
        checkboxNon.onchange = (e) => {
          if (e.target.checked) saveData(index, 'TRAVAUX ENEDIS', 'pdlPose', e.target.value);
        };
        const labelNon = document.createElement('label');
        labelNon.appendChild(checkboxNon);
        labelNon.appendChild(document.createTextNode('non'));

        const checkboxGroup = document.createElement('div');
        checkboxGroup.className = 'checkbox-group';
        checkboxGroup.appendChild(labelOui);
        checkboxGroup.appendChild(labelNon);

        const commentaireGroup = document.createElement('div');
        commentaireGroup.className = 'form-group';
        commentaireGroup.innerHTML = '<label>Commentaire :</label>';
        const commentaireInput = document.createElement('textarea');
        commentaireInput.rows = 2;
        commentaireInput.value = folder.visiteTechnique?.['TRAVAUX ENEDIS']?.commentaire || '';
        commentaireInput.oninput = (e) =>
          saveData(index, 'TRAVAUX ENEDIS', 'commentaire', e.target.value);
        commentaireGroup.appendChild(commentaireInput);

        const nombrePdlGroup = document.createElement('div');
        nombrePdlGroup.className = 'form-group';
        nombrePdlGroup.innerHTML = '<label>Nombre de PDL :</label>';
        const selectPdl = document.createElement('select');
        for (let i = 0; i <= 3; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = i;
          if (folder.visiteTechnique?.['TRAVAUX ENEDIS']?.nombrePdl == i) option.selected = true;
          selectPdl.appendChild(option);
        }
        selectPdl.onchange = (e) =>
          saveData(index, 'TRAVAUX ENEDIS', 'nombrePdl', e.target.value);
        nombrePdlGroup.appendChild(selectPdl);

        travauxContent.appendChild(pdlPoseGroup);
        travauxContent.appendChild(checkboxGroup);
        travauxContent.appendChild(commentaireGroup);
        travauxContent.appendChild(nombrePdlGroup);

        // CATEGORIE DU BATIMENT section
        const categorieTitle = document.createElement('div');
        categorieTitle.className = 'section-title';
        categorieTitle.id = `section-title-${index}-categorie`;
        categorieTitle.innerHTML = 'CATEGORIE DU BATIMENT <span class="arrow">▼</span>';
        categorieTitle.onclick = () => toggleSection(index, 'categorie');

        const categorieContent = document.createElement('div');
        categorieContent.className = 'section-content';
        categorieContent.id = `section-content-${index}-categorie`;

        const typeBatimentGroup = document.createElement('div');
        typeBatimentGroup.className = 'form-group';
        typeBatimentGroup.innerHTML = '<label>Type de bâtiment :</label>';
        const selectTypeBatiment = document.createElement('select');
        ['', 'Agricole', 'Industriel'].forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          if (folder.visiteTechnique?.['CATEGORIE DU BATIMENT']?.typeBatiment === opt) option.selected = true;
          selectTypeBatiment.appendChild(option);
        });
        selectTypeBatiment.onchange = (e) =>
          saveData(index, 'CATEGORIE DU BATIMENT', 'typeBatiment', e.target.value);
        typeBatimentGroup.appendChild(selectTypeBatiment);

        const classeGroup = document.createElement('div');
        classeGroup.className = 'form-group';
        classeGroup.innerHTML = '<label>Classé :</label>';
        const selectClasse = document.createElement('select');
        ['', 'ICPE', 'ERP', 'ERT'].forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          if (folder.visiteTechnique?.['CATEGORIE DU BATIMENT']?.classe === opt) option.selected = true;
          selectClasse.appendChild(option);
        });
        selectClasse.onchange = (e) =>
          saveData(index, 'CATEGORIE DU BATIMENT', 'classe', e.target.value);
        classeGroup.appendChild(selectClasse);

        categorieContent.appendChild(typeBatimentGroup);
        categorieContent.appendChild(classeGroup);

        // Assemble sections in content
        content.appendChild(planningTitle);
        content.appendChild(planningContent);

        content.appendChild(raccordementTitle);
        content.appendChild(raccordementContent);

        content.appendChild(puissancesTitle);
        content.appendChild(puissancesContent);

        content.appendChild(travauxTitle);
        content.appendChild(travauxContent);

        content.appendChild(categorieTitle);
        content.appendChild(categorieContent);

        // Print button
        const printBtn = document.createElement('button');
        printBtn.textContent = 'Imprimer ce dossier';
        printBtn.onclick = () => printFolder(index);

        content.appendChild(printBtn);

        div.appendChild(header);
        div.appendChild(content);
        container.appendChild(div);
      });
    }

    render();
  </script>
</body>
</html>
