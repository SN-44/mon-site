<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visite Technique</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0; padding: 0;
    }
    header {
      background-color: #007acc;
      padding: 15px;
      color: white;
      text-align: center;
    }
    nav {
      display: flex;
      background-color: #005a99;
    }
    nav a {
      flex: 1;
      padding: 15px;
      color: white;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s;
    }
    nav a:hover, nav a.active {
      background-color: #004c82;
      font-weight: bold;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .folder {
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .folder-header {
      background-color: #f1f1f1;
      padding: 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      font-weight: bold;
      font-size: 1.1em;
    }
    .folder-header span {
      transition: transform 0.3s ease;
      display: inline-block;
    }
    .folder-header.open span {
      transform: rotate(180deg);
    }
    .folder-content {
      display: none;
      padding: 15px;
    }
    .section-title {
      font-weight: bold;
      color: black;
      background-color: #e0e0e0;
      padding: 10px;
      border-radius: 4px;
      margin-top: 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    .section-title span {
      transition: transform 0.3s ease;
      display: inline-block;
    }
    .section-title.open span {
      transform: rotate(180deg);
    }
    .section-content {
      display: none;
      padding-top: 10px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: normal;
    }
    input[type="text"], input[type="date"], select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95em;
      box-sizing: border-box;
      resize: vertical;
    }
    textarea {
      min-height: 40px;
    }
    button {
      padding: 10px 15px;
      background-color: #007acc;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
      display: block;
      width: 100%;
      max-width: 300px;
    }
    button:hover {
      background-color: #005fa3;
    }
  </style>
</head>
<body>
  <header>
    <h1>Visite Technique</h1>
  </header>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="visite-technique.html" class="active">Visite technique</a>
    <a href="suivi-chantier.html">Suivi de chantier</a>
    <a href="mise-en-service.html">Mise en service</a>
  </nav>
  <main id="folders-container"></main>

  <script>
    const container = document.getElementById('folders-container');
    let folders = JSON.parse(localStorage.getItem('folders')) || [];

    function toggleDisplay(element) {
      if (element.style.display === 'block') {
        element.style.display = 'none';
      } else {
        element.style.display = 'block';
      }
    }

    function toggleFolderContent(index, headerElem) {
      const content = document.getElementById('content-' + index);
      toggleDisplay(content);
      headerElem.classList.toggle('open');
    }

    function toggleSection(sectionId, titleElem) {
      const sectionContent = document.getElementById(sectionId);
      toggleDisplay(sectionContent);
      titleElem.classList.toggle('open');
    }

    function saveData(index, field, value) {
      if (!folders[index].visiteTechnique) {
        folders[index].visiteTechnique = {};
      }
      folders[index].visiteTechnique[field] = value;
      localStorage.setItem('folders', JSON.stringify(folders));
    }

    function saveDataNested(index, section, field, value) {
      if (!folders[index].visiteTechnique) {
        folders[index].visiteTechnique = {};
      }
      if (!folders[index].visiteTechnique[section]) {
        folders[index].visiteTechnique[section] = {};
      }
      folders[index].visiteTechnique[section][field] = value;
      localStorage.setItem('folders', JSON.stringify(folders));
    }

    function render() {
      container.innerHTML = '';

      folders.forEach((folder, index) => {
        const div = document.createElement('div');
        div.className = 'folder';

        // Folder header with toggler arrow
        const header = document.createElement('div');
        header.className = 'folder-header';
        header.innerHTML = `<span>${folder.name}</span><span>▼</span>`;
        header.onclick = () => toggleFolderContent(index, header);

        // Folder content container
        const content = document.createElement('div');
        content.className = 'folder-content';
        content.id = 'content-' + index;

        // Helper to create a collapsible section with title & content div
        function createSection(title, sectionId) {
          const section = document.createElement('div');

          const sectionTitle = document.createElement('div');
          sectionTitle.className = 'section-title';
          sectionTitle.innerHTML = `${title} <span>▼</span>`;
          sectionTitle.onclick = () => toggleSection(sectionId, sectionTitle);

          const sectionContent = document.createElement('div');
          sectionContent.className = 'section-content';
          sectionContent.id = sectionId;

          section.appendChild(sectionTitle);
          section.appendChild(sectionContent);

          return { section, sectionContent };
        }

        // --- Section PLANNING ---
        const planning = createSection('PLANNING', `planning-${index}`);
        planning.sectionContent.innerHTML = `
          <div class="form-group">
            <label>Intervention en :</label>
            <input type="date" value="${folder.visiteTechnique?.intervention || ''}" onchange="saveData(${index}, 'intervention', this.value)">
          </div>
          <div class="form-group">
            <label>Équipe :</label>
            <textarea rows="2" oninput="saveData(${index}, 'equipe', this.value)">${folder.visiteTechnique?.equipe || ''}</textarea>
          </div>
          <div class="form-group">
            <label>Contact chef d'équipe :</label>
            <textarea rows="2" oninput="saveData(${index}, 'contact', this.value)">${folder.visiteTechnique?.contact || ''}</textarea>
          </div>
        `;
        content.appendChild(planning.section);

        // --- Section RACCORDEMENT ---
        const raccordement = createSection('RACCORDEMENT', `raccordement-${index}`);
        const raccordementValue = folder.visiteTechnique?.raccordement || '';
        raccordement.sectionContent.innerHTML = `
          <div class="form-group">
            <label>Type de raccordement :</label>
            <select onchange="saveData(${index}, 'raccordement', this.value)">
              <option value="">-- Sélectionner --</option>
              <option value="Vente total" ${raccordementValue === 'Vente total' ? 'selected' : ''}>Vente total</option>
              <option value="Autoconsommation" ${raccordementValue === 'Autoconsommation' ? 'selected' : ''}>Autoconsommation</option>
              <option value="Vente de surplus" ${raccordementValue === 'Vente de surplus' ? 'selected' : ''}>Vente de surplus</option>
            </select>
          </div>
        `;
        content.appendChild(raccordement.section);

        // --- Section PUISSANCES ---
        const puissances = createSection('PUISSANCES', `puissances-${index}`);
        const puissancesData = folder.visiteTechnique?.puissances || {};
        puissances.sectionContent.innerHTML = `
          <div class="form-group">
            <label>Puissance de raccordement :</label>
            <textarea rows="1" oninput="saveDataNested(${index}, 'puissances', 'puissanceRaccordement', this.value)">${puissancesData.puissanceRaccordement || ''}</textarea>
          </div>
          <div class="form-group">
            <label>Puissance de projet PV :</label>
            <textarea rows="1" oninput="saveDataNested(${index}, 'puissances', 'puissanceProjetPV', this.value)">${puissancesData.puissanceProjetPV || ''}</textarea>
          </div>
        `;
        content.appendChild(puissances.section);

        // --- Section TRAVAUX ENEDIS ---
        const travaux = createSection('TRAVAUX ENEDIS', `travaux-${index}`);
        const travauxData = folder.visiteTechnique?.travaux || {};
        travaux.sectionContent.innerHTML = `
          <div class="form-group">
            <label>PDL posé(s) lors de la VT :</label>
            <label><input type="radio" name="pdl-${index}" value="oui" ${travauxData.pdlPoses === 'oui' ? 'checked' : ''} onchange="saveDataNested(${index}, 'travaux', 'pdlPoses', this.value)"> Oui</label>
            <label><input type="radio" name="pdl-${index}" value="non" ${travauxData.pdlPoses === 'non' ? 'checked' : ''} onchange="saveDataNested(${index}, 'travaux', 'pdlPoses', this.value)"> Non</label>
            <textarea rows="2" placeholder="Commentaires..." oninput="saveDataNested(${index}, 'travaux', 'commentairePDL', this.value)">${travauxData.commentairePDL || ''}</textarea>
          </div>
          <div class="form-group">
            <label>Nombre de PDL :</label>
            <select onchange="saveDataNested(${index}, 'travaux', 'nombrePDL', this.value)">
              <option value="">-- Sélectionner --</option>
              <option value="0" ${travauxData.nombrePDL === '0' ? 'selected' : ''}>0</option>
              <option value="1" ${travauxData.nombrePDL === '1' ? 'selected' : ''}>1</option>
              <option value="2" ${travauxData.nombrePDL === '2' ? 'selected' : ''}>2</option>
              <option value="3" ${travauxData.nombrePDL === '3' ? 'selected' : ''}>3</option>
            </select>
          </div>
        `;
        content.appendChild(travaux.section);

        // --- Section CATEGORIE DU BATIMENT ---
        const categorie = createSection('CATEGORIE DU BATIMENT', `categorie-${index}`);
        const categorieData = folder.visiteTechnique?.categorie || {};
        categorie.sectionContent.innerHTML = `
          <div class="form-group">
            <label>Type de bâtiment :</label>
            <select onchange="saveDataNested(${index}, 'categorie', 'typeBatiment', this.value)">
              <option value="">-- Sélectionner --</option>
              <option value="Agricole" ${categorieData.typeBatiment === 'Agricole' ? 'selected' : ''}>Agricole</option>
              <option value="Industriel" ${categorieData.typeBatiment === 'Industriel' ? 'selected' : ''}>Industriel</option>
            </select>
          </div>
          <div class="form-group">
            <label>Classé :</label>
            <select onchange="saveDataNested(${index}, 'categorie', 'classe', this.value)">
              <option value="">-- Sélectionner --</option>
              <option value="ICPE" ${categorieData.classe === 'ICPE' ? 'selected' : ''}>ICPE</option>
              <option value="ERP" ${categorieData.classe === 'ERP' ? 'selected' : ''}>ERP</option>
              <option value="ERT" ${categorieData.classe === 'ERT' ? 'selected' : ''}>ERT</option>
            </select>
          </div>
          <div class="form-group">
            <label>Année de construction :</label>
            <input type="text" value="${categorieData.anneeConstruction || ''}" onchange="saveDataNested(${index}, 'categorie', 'anneeConstruction', this.value)">
          </div>
        `;
        content.appendChild(categorie.section);

        div.appendChild(header);
        div.appendChild(content);

        container.appendChild(div);
      });
    }

    // Pour test initial, si pas de dossiers, on en crée un par défaut
    if(folders.length === 0){
      folders = [
        {name: 'Dossier A', visiteTechnique: {}},
        {name: 'Dossier B', visiteTechnique: {}},
      ];
      localStorage.setItem('folders', JSON.stringify(folders));
    }

    render();

    // Gestion globale pour que les fonctions inline appellent celles du scope global
    window.saveData = saveData;
    window.saveDataNested = saveDataNested;
  </script>
</body>
</html>
