<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visite Technique</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0; padding: 0;
    }
    header {
      background-color: #007acc;
      padding: 15px;
      color: white;
      text-align: center;
    }
    nav {
      display: flex;
      background-color: #005a99;
    }
    nav a {
      flex: 1;
      padding: 15px;
      color: white;
      text-decoration: none;
      text-align: center;
      transition: background-color 0.3s;
    }
    nav a:hover, nav a.active {
      background-color: #004c82;
      font-weight: bold;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .folder {
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .folder-header {
      background-color: #f1f1f1;
      padding: 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      font-weight: bold;
    }
    .folder-header span {
      display: inline-block;
      transition: transform 0.3s ease;
    }
    .folder-header.open span {
      transform: rotate(180deg);
    }
    .folder-content {
      display: none;
      padding: 15px;
    }
    .section-title {
      font-weight: bold;
      color: black;
      background-color: #e0e0e0;
      padding: 10px;
      border-radius: 4px;
      margin-top: 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    .section-title span {
      display: inline-block;
      transition: transform 0.3s ease;
    }
    .section-title.open span {
      transform: rotate(180deg);
    }
    .section-content {
      display: none;
      padding-top: 10px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: normal;
    }
    input[type="text"], input[type="date"], select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
    }
    .checkbox-group label {
      display: inline-flex;
      align-items: center;
      margin-right: 15px;
      cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
      margin-left: 8px;
      cursor: pointer;
    }
    button {
      padding: 10px 15px;
      background-color: #007acc;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 10px 0 0;
      user-select: none;
    }
    button:hover {
      background-color: #005fa3;
    }
    button.delete {
      background-color: #cc0000;
    }
    button.delete:hover {
      background-color: #990000;
    }
  </style>
</head>
<body>
<header>
  <h1>Visite Technique</h1>
</header>
<nav>
  <a href="index.html">Accueil</a>
  <a href="visite-technique.html" class="active">Visite technique</a>
  <a href="suivi-chantier.html">Suivi de chantier</a>
  <a href="mise-en-service.html">Mise en service</a>
</nav>
<main id="folders-container"></main>

<script>
  const container = document.getElementById('folders-container');
  let folders = JSON.parse(localStorage.getItem('folders')) || [];

  // Toggle folder content visibility and rotate arrow
  function toggleContent(index) {
    const content = document.getElementById('content-' + index);
    const header = document.getElementById('header-' + index);
    const isOpen = content.style.display === 'block';
    content.style.display = isOpen ? 'none' : 'block';
    if(isOpen) header.classList.remove('open'); else header.classList.add('open');
  }

  // Toggle section visibility and rotate arrow
  function toggleSection(id) {
    const section = document.getElementById(id);
    const title = document.getElementById(id + '-title');
    const isOpen = section.style.display === 'block';
    section.style.display = isOpen ? 'none' : 'block';
    if(isOpen) title.classList.remove('open'); else title.classList.add('open');
  }

  // Save data on change to localStorage
  function saveData(folderIndex, field, value) {
    folders[folderIndex].visiteTechnique = folders[folderIndex].visiteTechnique || {};
    folders[folderIndex].visiteTechnique[field] = value;
    localStorage.setItem('folders', JSON.stringify(folders));
  }

  // For TRAVAUX ENEDIS oui/non exclusif behavior
  function travauxEnedisToggle(folderIndex, fieldClicked) {
    const folder = folders[folderIndex];
    folder.visiteTechnique = folder.visiteTechnique || {};
    if(fieldClicked === 'pdlPoseOui') {
      folder.visiteTechnique.pdlPoseOui = true;
      folder.visiteTechnique.pdlPoseNon = false;
    } else if(fieldClicked === 'pdlPoseNon') {
      folder.visiteTechnique.pdlPoseOui = false;
      folder.visiteTechnique.pdlPoseNon = true;
    }
    localStorage.setItem('folders', JSON.stringify(folders));
    render();
  }

  function deleteFolder(index) {
    if(confirm("Voulez-vous vraiment supprimer ce dossier ?")) {
      folders.splice(index, 1);
      localStorage.setItem('folders', JSON.stringify(folders));
      render();
    }
  }

  // Print one folder with all sections fully expanded
  function printFolder(index) {
    const folder = folders[index];
    const tempDiv = document.createElement('div');
    tempDiv.style.padding = "20px";
    tempDiv.style.fontFamily = "Arial, sans-serif";

    const title = document.createElement('h2');
    title.textContent = folder.name;
    tempDiv.appendChild(title);

    // Append each section fully expanded with content
    function createPrintSection(titleText, htmlContent) {
      const sectionTitle = document.createElement('h3');
      sectionTitle.style.backgroundColor = '#e0e0e0';
      sectionTitle.style.padding = '8px';
      sectionTitle.style.borderRadius = '4px';
      sectionTitle.style.marginTop = '20px';
      sectionTitle.textContent = titleText;
      tempDiv.appendChild(sectionTitle);

      const sectionContent = document.createElement('div');
      sectionContent.innerHTML = htmlContent;
      sectionContent.style.marginTop = '8px';
      tempDiv.appendChild(sectionContent);
    }

    const vt = folder.visiteTechnique || {};

    // PLANNING
    createPrintSection('PLANNING', `
      <p><strong>Intervention en :</strong> ${vt.interventionEn || ''}</p>
      <p><strong>Equipe :</strong> ${vt.equipe || ''}</p>
      <p><strong>Contact chef d\'équipe :</strong> ${vt.contactChefEquipe || ''}</p>
    `);

    // RACCORDEMENT
    createPrintSection('RACCORDEMENT', `
      <p><strong>Type de raccordement :</strong> ${vt.typeRaccordement || ''}</p>
    `);

    // PUISSANCES
    createPrintSection('PUISSANCES', `
      <p><strong>Puissance de raccordement :</strong> ${vt.puissanceRaccordement || ''}</p>
      <p><strong>Puissance de projet PV :</strong> ${vt.puissanceProjetPV || ''}</p>
    `);

    // TRAVAUX ENEDIS
    createPrintSection('TRAVAUX ENEDIS', `
      <p><strong>PDL posé(s) lors de la VT :</strong> ${vt.pdlPoseOui ? 'Oui' : vt.pdlPoseNon ? 'Non' : ''}</p>
    `);

    // CATEGORIE DU BATIMENT
    createPrintSection('CATEGORIE DU BATIMENT', `
      <p><strong>Type de bâtiment :</strong> ${vt.typeBatiment || ''}</p>
      <p><strong>Classé :</strong> ${vt.classement || ''}</p>
    `);

    // DATE DE VISITE TECHNIQUE
    createPrintSection('DATE DE VISITE TECHNIQUE', `
      <p><strong>Date de la visite :</strong> ${vt.dateVisite || ''}</p>
    `);

    // SORTIE CÂBLE AC
    createPrintSection('SORTIE CÂBLE AC', `
      <p><strong>Droite :</strong> ${vt.sortieACDroite ? 'Oui' : 'Non'}</p>
      <p><strong>Gauche :</strong> ${vt.sortieACGauche ? 'Oui' : 'Non'}</p>
    `);

    // Generate PDF
    const opt = {
      margin: 0.5,
      filename: `${folder.name}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().from(tempDiv).set(opt).save();
  }

  // Render all folders and their inputs
  function render() {
    container.innerHTML = '';
    folders.forEach((folder, index) => {
      const div = document.createElement('div');
      div.className = 'folder';

      // Header with toggle
      const header = document.createElement('div');
      header.className = 'folder-header';
      header.id = 'header-' + index;
      header.innerHTML = `<span>${folder.name}</span><span>▼</span>`;
      header.onclick = () => toggleContent(index);

      // Content container
      const content = document.createElement('div');
      content.className = 'folder-content';
      content.id = 'content-' + index;

      // PLANNING section
      const planningTitle = document.createElement('div');
      planningTitle.className = 'section-title';
      planningTitle.id = `planning-title-${index}`;
      planningTitle.innerHTML = `PLANNING <span>▼</span>`;
      planningTitle.onclick = () => toggleSection(`planning-${index}`);
      const planningContent = document.createElement('div');
      planningContent.className = 'section-content';
      planningContent.id = `planning-${index}`;
      planningContent.innerHTML = `
        <div class="form-group">
          <label>Intervention en :</label>
          <input type="date" value="${folder.visiteTechnique?.interventionEn || ''}" onchange="saveData(${index}, 'interventionEn', this.value)" />
        </div>
        <div class="form-group">
          <label>Equipe :</label>
          <input type="text" value="${folder.visiteTechnique?.equipe || ''}" onchange="saveData(${index}, 'equipe', this.value)" />
        </div>
        <div class="form-group">
          <label>Contact chef d'équipe :</label>
          <input type="text" value="${folder.visiteTechnique?.contactChefEquipe || ''}" onchange="saveData(${index}, 'contactChefEquipe', this.value)" />
        </div>
      `;
      planningContent.style.display = 'none';

      // RACCORDEMENT section
      const raccordementTitle = document.createElement('div');
      raccordementTitle.className = 'section-title';
      raccordementTitle.id = `raccordement-title-${index}`;
      raccordementTitle.innerHTML = `RACCORDEMENT <span>▼</span>`;
      raccordementTitle.onclick = () => toggleSection(`raccordement-${index}`);
      const raccordementContent = document.createElement('div');
      raccordementContent.className = 'section-content';
      raccordementContent.id = `raccordement-${index}`;
      raccordementContent.innerHTML = `
        <div class="form-group">
          <label>Type de raccordement :</label>
          <input type="text" value="${folder.visiteTechnique?.typeRaccordement || ''}" onchange="saveData(${index}, 'typeRaccordement', this.value)" />
        </div>
      `;
      raccordementContent.style.display = 'none';

      // PUISSANCES section
      const puissancesTitle = document.createElement('div');
      puissancesTitle.className = 'section-title';
      puissancesTitle.id = `puissances-title-${index}`;
      puissancesTitle.innerHTML = `PUISSANCES <span>▼</span>`;
      puissancesTitle.onclick = () => toggleSection(`puissances-${index}`);
      const puissancesContent = document.createElement('div');
      puissancesContent.className = 'section-content';
      puissancesContent.id = `puissances-${index}`;
      puissancesContent.innerHTML = `
        <div class="form-group">
          <label>Puissance de raccordement :</label>
          <input type="text" value="${folder.visiteTechnique?.puissanceRaccordement || ''}" onchange="saveData(${index}, 'puissanceRaccordement', this.value)" />
        </div>
        <div class="form-group">
          <label>Puissance de projet PV :</label>
          <input type="text" value="${folder.visiteTechnique?.puissanceProjetPV || ''}" onchange="saveData(${index}, 'puissanceProjetPV', this.value)" />
        </div>
      `;
      puissancesContent.style.display = 'none';

      // TRAVAUX ENEDIS section
      const travauxTitle = document.createElement('div');
      travauxTitle.className = 'section-title';
      travauxTitle.id = `travaux-title-${index}`;
      travauxTitle.innerHTML = `TRAVAUX ENEDIS <span>▼</span>`;
      travauxTitle.onclick = () => toggleSection(`travaux-${index}`);
      const travauxContent = document.createElement('div');
      travauxContent.className = 'section-content checkbox-group';
      travauxContent.id = `travaux-${index}`;
      travauxContent.innerHTML = `
        <label>PDL posé(s) lors de la VT
          <input
            type="checkbox"
            onchange="travauxEnedisToggle(${index}, 'pdlPoseOui')"
            ${folder.visiteTechnique?.pdlPoseOui ? 'checked' : ''}
          />
          Oui
        </label>
        <label>
          <input
            type="checkbox"
            onchange="travauxEnedisToggle(${index}, 'pdlPoseNon')"
            ${folder.visiteTechnique?.pdlPoseNon ? 'checked' : ''}
          />
          Non
        </label>
      `;
      travauxContent.style.display = 'none';

      // CATEGORIE DU BATIMENT section
      const catBatimentTitle = document.createElement('div');
      catBatimentTitle.className = 'section-title';
      catBatimentTitle.id = `catBatiment-title-${index}`;
      catBatimentTitle.innerHTML = `CATEGORIE DU BATIMENT <span>▼</span>`;
      catBatimentTitle.onclick = () => toggleSection(`catBatiment-${index}`);
      const catBatimentContent = document.createElement('div');
      catBatimentContent.className = 'section-content';
      catBatimentContent.id = `catBatiment-${index}`;
      catBatimentContent.innerHTML = `
        <div class="form-group">
          <label>Type de bâtiment :</label>
          <input type="text" value="${folder.visiteTechnique?.typeBatiment || ''}" onchange="saveData(${index}, 'typeBatiment', this.value)" />
        </div>
        <div class="form-group">
          <label>Classé :</label>
          <input type="text" value="${folder.visiteTechnique?.classement || ''}" onchange="saveData(${index}, 'classement', this.value)" />
        </div>
      `;
      catBatimentContent.style.display = 'none';

      // DATE DE VISITE TECHNIQUE section
      const dateVisiteTitle = document.createElement('div');
      dateVisiteTitle.className = 'section-title';
      dateVisiteTitle.id = `dateVisite-title-${index}`;
      dateVisiteTitle.innerHTML = `DATE DE VISITE TECHNIQUE <span>▼</span>`;
      dateVisiteTitle.onclick = () => toggleSection(`dateVisite-${index}`);
      const dateVisiteContent = document.createElement('div');
      dateVisiteContent.className = 'section-content';
      dateVisiteContent.id = `dateVisite-${index}`;
      dateVisiteContent.innerHTML = `
        <div class="form-group">
          <label>Date de la visite :</label>
          <input type="date" value="${folder.visiteTechnique?.dateVisite || ''}" onchange="saveData(${index}, 'dateVisite', this.value)" />
        </div>
      `;
      dateVisiteContent.style.display = 'none';

      // SORTIE CÂBLE AC section
      const sortieACTitle = document.createElement('div');
      sortieACTitle.className = 'section-title';
      sortieACTitle.id = `sortieAC-title-${index}`;
      sortieACTitle.innerHTML = `SORTIE CÂBLE AC <span>▼</span>`;
      sortieACTitle.onclick = () => toggleSection(`sortieAC-${index}`);
      const sortieACContent = document.createElement('div');
      sortieACContent.className = 'section-content checkbox-group';
      sortieACContent.id = `sortieAC-${index}`;
      sortieACContent.innerHTML = `
        <label>Droite
          <input
            type="checkbox"
            onchange="saveData(${index}, 'sortieACDroite', this.checked)"
            ${folder.visiteTechnique?.sortieACDroite ? 'checked' : ''}
          />
        </label>
        <label>Gauche
          <input
            type="checkbox"
            onchange="saveData(${index}, 'sortieACGauche', this.checked)"
            ${folder.visiteTechnique?.sortieACGauche ? 'checked' : ''}
          />
        </label>
      `;
      sortieACContent.style.display = 'none';

      // Buttons container
      const btnContainer = document.createElement('div');
      btnContainer.style.marginTop = '15px';

      const printBtn = document.createElement('button');
      printBtn.textContent = 'Imprimer / Exporter PDF';
      printBtn.onclick = () => printFolder(index);

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Supprimer';
      deleteBtn.className = 'delete';
      deleteBtn.onclick = () => deleteFolder(index);

      btnContainer.appendChild(printBtn);
      btnContainer.appendChild(deleteBtn);

      // Append all sections to content
      content.appendChild(planningTitle);
      content.appendChild(planningContent);
      content.appendChild(raccordementTitle);
      content.appendChild(raccordementContent);
      content.appendChild(puissancesTitle);
      content.appendChild(puissancesContent);
      content.appendChild(travauxTitle);
      content.appendChild(travauxContent);
      content.appendChild(catBatimentTitle);
      content.appendChild(catBatimentContent);
      content.appendChild(dateVisiteTitle);
      content.appendChild(dateVisiteContent);
      content.appendChild(sortieACTitle);
      content.appendChild(sortieACContent);
      content.appendChild(btnContainer);

      div.appendChild(header);
      div.appendChild(content);
      container.appendChild(div);
    });
  }

  // Initial render
  render();
</script>
</body>
</html>
